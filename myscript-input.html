<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../myscript-core/myscript-core.html">

<dom-module id="myscript-input">
    <style>
        :host {
            display: inline-block;
        }
        canvas {
            background:url(background-pattern.png);
            display: block;
        }
    </style>
    <template>
        <canvas id="canvas" width="{{width}}" height="{{height}}"></canvas>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'myscript-input',
        properties: {
            width: {
                type: Number,
                value: 300,
                notify: true
            },
            height: {
                type: Number,
                value: 150,
                notify: true
            },
            type: {
                type: String,
                value: 'TEXT'
            },
            timeout: {
                type: Number
            },
            url: String,
            applicationKey: String,
            hmacKey: String
        },
        listeners: {
            down: '_down',
            track: '_track',
            up: '_up'
        },
        _down: function(e) {
            this._selectedRenderer.drawStart(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, this.$.canvas.getContext('2d'));
            this._inkManager.startInkCapture(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, e.timeStamp);
            this._isWriting = true;
        },
        _track: function(e) {
            if (this._isWriting) {
                this._selectedRenderer.drawContinue(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, this.$.canvas.getContext('2d'));
                this._inkManager.continueInkCapture(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, e.timeStamp);
            }
        },
        _up: function(e) {
            if (this._isWriting) {
                this._selectedRenderer.drawEnd(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, this.$.canvas.getContext('2d'));
                this._inkManager.endInkCapture(e.detail.x - e.srcElement.offsetLeft, e.detail.y - e.srcElement.offsetTop, e.timeStamp);
                this._isWriting = undefined;
                if (this.timeout != null) {
                    this.debounce('timer', function () {
                        this._doRecognition(this._inkManager.getStrokes())
                    }, this.timeout);
                }
            }
        },
        _clear: function() {
            this._instanceId = undefined;
            this._selectedRenderer.clear(this.$.canvas.getContext('2d'));
            this._inkManager.clear();
        },
        _doRecognition: function (components) {
            var input = [];
            if (this._selectedRecognizer instanceof MyScript.TextRecognizer) {
                var inputUnit = new MyScript.TextInputUnit();
                inputUnit.setComponents(components);
                input = [inputUnit];
            } else {
                input = input.concat(components);
            }
            this._selectedRecognizer.doSimpleRecognition(this.applicationKey, this._instanceId, input, this.hmacKey).then(
                    function success(data) {
                        if (!this._instanceId) {
                            this._instanceId = data.getInstanceId();
                        } else if (this._instanceId !== data.getInstanceId()) {
                            return;
                        }
                        this._selectedRenderer.clear(this.$.canvas.getContext('2d'));
                        this._drawRecognitionResult(input, data);
                    }.bind(this)
            );
        },
        _drawRecognitionResult: function (input, result) {
            var data;
            if (result instanceof MyScript.TextResult) {
                data = result.getTextDocument();
            } else if (result instanceof MyScript.MathResult) {
                data = result.getMathDocument();
            } else if (result instanceof MyScript.ShapeResult) {
                data = result.getShapeDocument();
            } else if (result instanceof MyScript.AnalyzerResult) {
                data = result.getAnalyzerDocument();
            } else if (result instanceof MyScript.MusicResult) {
                data = result.getMusicDocument();
            }
            this._selectedRenderer.drawRecognitionResult(input, data, this.$.canvas.getContext('2d'));
        },
        attached: function () {
            this._inkManager = new MyScript.InkManager();
            // Renderers
            this._textRenderer = new MyScript.TextRenderer();
            this._mathRenderer = new MyScript.MathRenderer();
            this._shapeRenderer = new MyScript.ShapeRenderer();
            this._analyzerRenderer = new MyScript.AnalyzerRenderer();
            this._musicRenderer = new MyScript.MusicRenderer();
            // Recognizers
            this._textRecognizer = new MyScript.TextRecognizer(this.url);
            this._mathRecognizer = new MyScript.MathRecognizer(this.url);
            this._shapeRecognizer = new MyScript.ShapeRecognizer(this.url);
            this._analyzerRecognizer = new MyScript.AnalyzerRecognizer(this.url);
            this._musicRecognizer = new MyScript.MusicRecognizer(this.url);
            // Variables
            switch (this.type) {
                case 'TEXT':
                    this._selectedRenderer = this._textRenderer;
                    this._selectedRecognizer = this._textRecognizer;
                    break;
                case 'MATH':
                    this._selectedRenderer = this._mathRenderer;
                    this._selectedRecognizer = this._mathRecognizer;
                    break;
                case 'SHAPE':
                    this._selectedRenderer = this._shapeRenderer;
                    this._selectedRecognizer = this._shapeRecognizer;
                    break;
                case 'ANALYZER':
                    this._selectedRenderer = this._analyzerRenderer;
                    this._selectedRecognizer = this._analyzerRecognizer;
                    break;
                case 'MUSIC':
                    this._selectedRenderer = this._musicRenderer;
                    this._selectedRecognizer = this._musicRecognizer;
                    break;
                default:
                    throw new Error('Unknown type: ' + this.type);
            }
        }
    });
</script>
